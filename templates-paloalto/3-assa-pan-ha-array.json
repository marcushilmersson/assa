  {
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "vmNamePrefix": {
        "type": "array",
        "defaultValue": ["panfw01", "panfw02"],
        "metadata": { 
          "description": "Name of VM-Series FWs in the Azure portal."
        }
      },
        "vmSize": {
        "type": "string",
        "defaultValue": "Standard_D3_v2",
        "allowedValues": [
          "Standard_D3",
          "Standard_D4",
          "Standard_D3_v2",
          "Standard_D4_v2",
          "Standard_A4",
          "Standard_DS3_v2",
          "Standard_DS4_v2"
        ],
        "metadata": {
          "description": "Azure VM size for VM-Series"
        }
      },
      "vmImageVersion": {
        "type": "string",
        "defaultValue": "latest",
        "allowedValues": [
          "9.0.6",
          "latest"
        ],
        "metadata": {
          "description": "PAN OS Version | az vm image list -l westeurope -p paloaltonetworks --all"
        }
      },
      "vmImageSku": {
        "type": "string",
        "defaultValue": "byol",
        "allowedValues": [
          "byol",
          "bundle1",
          "bundle2"
        ],
        "metadata": {
          "description": "Firewall License Model"
        }
      },
      "virtualNetworkName": {
        "type": "string",
        "defaultValue": "vn-security",
        "metadata": {
          "description": "Name of the EXISTING Virtual Network"
        }
      },
      "virtualNetworkResourceGroup": {
        "type": "string",
        "defaultValue": "rg-hub",
        "metadata": {
          "description": "Name of the EXISTING Virtual Network Resource Group"
        }
      },
      "virtualNetworkAddressPrefixes": {
        "type": "array",
        "defaultValue": "[array('10.0.0.0/16')]",
        "metadata": {
          "description": "Virtual network address CIDR"
        }
      },
      "mgmtSubnetName": {
        "type": "string",
        "defaultValue": "sn-mgmt",
        "metadata": {
          "description": "Subnet for Management"
        }
      },
      "externalSubnetName": {
        "type": "string",
        "defaultValue": "sn-external",
        "metadata": {
          "description": "Subnet for External"
        }
      },
      "internalSubnetName": {
        "type": "string",
        "defaultValue": "sn-internal",
        "metadata": {
          "description": "Subnet for Internal"
        }
      },
      "mgmtSubnetPrefix": {
        "type": "string",
        "defaultValue": "10.0.0.64/28",
        "metadata": {
          "description": "Mgmt subnet CIDR"
        }
      },
      "externalSubnetPrefix": {
        "type": "string",
        "defaultValue": "10.0.0.16/28",
        "metadata": {
          "description": "External subnet CIDR"
        }
      },
      "internalSubnetPrefix": {
        "type": "string",
        "defaultValue": "10.0.0.0/28",
        "metadata": {
          "description": "EXISTING internal subnet CIDR"
        }
      },
      "internalLbIpAddress": {
        "type": "string",
        "defaultValue": "10.0.0.4",
        "metadata": {
          "description": "Static IP-address for the internal subnet loadbalancer."
        }
      },
      "mgmtSubnetIpAddresses": {
        "type": "array",
        "defaultValue": ["10.0.0.68", "10.0.0.69"],
        "metadata": {
          "description": "Static IP-addresses for the FW in the management subnet (formatted as an array)."
        }
      },
      "externalSubnetIpAddresses": {
        "type": "array",
        "defaultValue": ["10.0.0.20", "10.0.0.21"],
        "metadata": {
          "description": "Static IP-addresses for the FW in the external subnet (formatted as an array)."
        }
      },
      "internalSubnetIpAddresses": {
        "type": "array",
        "defaultValue": ["10.0.0.6", "10.0.0.7"],
        "metadata": {
          "description": "Static IP-addresses for the FW in the internal subnet (formatted as an array)."
        }
      },
      "adminUsername": {
        "type": "string",
        "defaultValue": "panadmin",
        "metadata": {
          "description": "Username of the administrator account of VM-Series"
        }
      },
      "adminPassword": {
        "type": "securestring",
        "defaultValue": "",
        "metadata": {
          "description": "Password for the administrator account of VM-Series"
        }
      }
    },
    "variables": {
      
      "resourceGroupName":  "[resourceGroup().name]",
      "vmImagePublisher": "paloaltonetworks",
      "vmImageOffer": "vmseries1",


      "vnetId": "[resourceId(variables('virtualNetworkResourceGroup'),'Microsoft.Network/virtualNetworks',parameters('virtualNetworkName'))]",
      "virtualNetworkAddressPrefix": "[parameters('virtualNetworkAddressPrefixes')[0]]",
      "virtualNetworkResourceGroup": "[parameters('virtualNetworkResourceGroup')]",
      "mgmtSubnetRef": "[concat(variables('vnetId'),'/subnets/',parameters('mgmtSubnetName'))]",
      "externalSubnetRef": "[concat(variables('vnetId'),'/subnets/',parameters('externalSubnetName'))]",
      "internalSubnetRef": "[concat(variables('vnetId'),'/subnets/',parameters('internalSubnetName'))]",

      "lbFeName": "[variables('resourceGroupName')]",
      "lbBeName": "[variables('resourceGroupName')]",
      "lbProbeName": "[variables('resourceGroupName')]",

      "elbName": "[concat(variables('resourceGroupName'),'Ext')]",
      "elbId": "[resourceId('Microsoft.Network/loadBalancers',variables('elbName'))]",
      "elbPipName": "[concat(variables('resourceGroupName'),'Ext','-','FrontEnd')]",
      "elbPipId": "[resourceId('Microsoft.Network/publicIpAddresses',variables('elbPipName'))]",
      "elbBeRef": "[concat(variables('elbId'),'/backendAddressPools/',variables('lbBeName'))]",

      "ilbName": "[concat(variables('resourceGroupName'),'Int')]",
      "ilbId": "[resourceId('Microsoft.Network/loadBalancers',variables('ilbName'))]",
      "ilbInternalIp": "[parameters('internalLbIpAddress')]",
      "ilbInternalFeName": "[concat(variables('resourceGroupName'),'Int','-','FrontEnd')]", 
      "ilbInternalBeName": "[concat(variables('resourceGroupName'),'Int','-','BackEnd')]", 
      "ilbInternalBeRef": "[concat(variables('ilbId'),'/backendAddressPools/',variables('ilbInternalBeName'))]",


      "asName": "[concat(variables('resourceGroupName'))]",
      "asId": "[resourceId('Microsoft.Compute/availabilitySets',variables('asName'))]",

      "copy": [
        {
          "name": "vmNames",
          "count": "[length(parameters('vmNamePrefix'))]",
          "input": {
            "name": "[concat(parameters('vmNamePrefix')[copyIndex('vmNames')])]"
          }
        },
        {
          "name": "vmPipNames",
          "count": "[length(parameters('vmNamePrefix'))]",
          "input": {
            "name": "[concat(parameters('vmNamePrefix')[copyIndex('vmPipNames')], 'Ext')]"
          }
        },
        {
          "name": "vmMgmtNics",
          "count": "[length(parameters('vmNamePrefix'))]",
          "input": {
            "name": "[concat(parameters('vmNamePrefix')[copyIndex('vmMgmtNics')], 'Mgmt')]",
            "privateIpAddress": "[parameters('mgmtSubnetIpAddresses')[copyIndex('vmMgmtNics')]]"
          }
        },
        {
          "name": "vmExternalNics",
          "count": "[length(parameters('vmNamePrefix'))]",
          "input": {
            "name": "[concat(parameters('vmNamePrefix')[copyIndex('vmExternalNics')], 'Ext')]",
            "privateIpAddress": "[parameters('externalSubnetIpAddresses')[copyIndex('vmExternalNics')]]"
          }
        },
        {
          "name": "vmInternalNics",
          "count": "[length(parameters('vmNamePrefix'))]",
          "input": {
            "name": "[concat(parameters('vmNamePrefix')[copyIndex('vmInternalNics')], 'Int')]",
            "privateIpAddress": "[parameters('internalSubnetIpAddresses')[copyIndex('vmInternalNics')]]"
          }
        }
      ]
    },
    "resources": [
      {
        "comments": "Firewall public IP-addresses.",
        "apiVersion": "2018-08-01",
        "type": "Microsoft.Network/publicIPAddresses",
        "name": "[variables('vmPipNames')[copyIndex('vmPips')].name]",
        "location": "[resourceGroup().location]",
        "copy": {
          "name": "vmPips",
          "count": "[length(parameters('vmNamePrefix'))]"
        },
        "sku": { "name": "Standard" },
        "properties": { "publicIPAllocationMethod": "Static" }
      },
      {
        "comments": "External loadbalancer public IP-address.",
        "apiVersion": "2018-08-01",
        "type": "Microsoft.Network/publicIPAddresses",
        "name": "[variables('elbPipName')]",
        "location": "[resourceGroup().location]",
        "sku": { "name": "Standard" },
        "properties": { "publicIPAllocationMethod": "Static" }
      },
      {
        "comments": "External firewall loadbalancer.",
        "apiVersion": "2018-08-01",
        "type": "Microsoft.Network/loadBalancers",
        "name": "[variables('elbName')]",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "[variables('elbPipId')]"
        ],
        "sku": { "name": "Standard" },
        "properties": {
          "frontendIPConfigurations": [
            {
              "name": "[variables('lbFeName')]",
              "properties": {
                "publicIPAddress": { "id": "[variables('elbPipId')]" }
              }
            }
          ],
          "backendAddressPools": [{ "name": "[variables('lbBeName')]" }],
          "probes": [
            {
              "name": "[variables('lbProbeName')]",
              "properties": {
                "protocol": "Tcp",
                "port": 443,
                "intervalInSeconds": 5,
                "numberOfProbes": 2
              }
            }
          ]
        }
      },
      {
        "comments": "Internal loadbalancer.",
        "apiVersion": "2018-08-01",
        "type": "Microsoft.Network/loadBalancers",
        "name": "[variables('ilbName')]",
        "location": "[resourceGroup().location]",
        "dependsOn": [],
        "sku": { "name": "Standard" },
        "properties": {
          "frontendIPConfigurations": [
            {
              "name": "[variables('ilbInternalFeName')]",
              "properties": {
                "privateIPAddress": "[variables('ilbInternalIp')]",
                "privateIPAllocationMethod": "Static",
                "subnet": {
                  "id": "[variables('internalSubnetRef')]"
                }
              }
            }
          ],
          "backendAddressPools": [
            { "name": "[variables('ilbInternalBeName')]" }
          ],
          "loadBalancingRules": [
            {
              "name": "[concat(variables('resourceGroupName'),'Int')]",
              "properties": {
                "frontendIPConfiguration": {
                  "id": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('ilbName')),'/frontendIpConfigurations/',variables('ilbInternalFeName'))]"
                },
                "backendAddressPool": {
                  "id": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('ilbName')),'/backendAddressPools/',variables('ilbInternalBeName'))]"
                },
                "probe": {
                  "id": "[concat(resourceId('Microsoft.Network/loadBalancers',variables('ilbName')),'/probes/',variables('lbProbeName'))]"
                },
                "protocol": "All",
                "frontendPort": 0,
                "backendPort": 0,
                "enableFloatingIP": true,
                "idleTimeoutInMinutes": 15
              }
            }
          ],
          "probes": [
            {
              "name": "[variables('lbProbeName')]",
              "properties": {
                "protocol": "Tcp",
                "port": 443,
                "intervalInSeconds": 5,
                "numberOfProbes": 2
              }
            }
          ] 
        }
      },
      {
        "comments": "Management subnet NICs.",
        "apiVersion": "2018-08-01",
        "name": "[variables('vmMgmtNics')[copyIndex('mgmtNics')].name]",
        "type": "Microsoft.Network/networkInterfaces",
        "location": "[resourceGroup().location]",
        "dependsOn": [],
        "copy": {
          "name": "mgmtNics",
          "count": "[length(parameters('vmNamePrefix'))]"
        },
        "properties": {
          "ipConfigurations": [
            {
              "name": "[concat(variables('vmNames')[copyIndex('mgmtNics')].name,'Mgmt')]",
              "properties": {
                "privateIpAllocationMethod": "Static",
                "privateIpAddress": "[variables('vmMgmtNics')[copyIndex('mgmtNics')].privateIpAddress]",
                "subnet": {
                  "id": "[variables('mgmtSubnetRef')]"
                }
              }
            }
          ]
        }
      },
      {
        "comments": "External subnet NICs.",
        "apiVersion": "2018-08-01",
        "name": "[variables('vmExternalNics')[copyIndex('externalNics')].name]",
        "type": "Microsoft.Network/networkInterfaces",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "vmPips",
          "[variables('elbName')]"
        ],
        "copy": {
          "name": "externalNics",
          "count": "[length(parameters('vmNamePrefix'))]"
        },
        "properties": {
          "enableAcceleratedNetworking": true,
          "enableIPForwarding": true,
          "ipConfigurations": [
            {
              "name": "[concat(variables('vmNames')[copyIndex('externalNics')].name,'Ext')]",
              "properties": {
                "privateIPAllocationMethod": "Static",
                "privateIPAddress": "[variables('vmExternalNics')[copyIndex('externalNics')].privateIpAddress]",
                "publicIPAddress": {
                  "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('vmPipNames')[copyIndex('externalNics')].name)]"
                },
                "subnet": {
                  "id": "[variables('externalSubnetRef')]"
                },
                "loadBalancerBackendAddressPools": [
                  {
                    "id": "[variables('elbBeRef')]"
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "comments": "Internal subnet NICs.",
        "apiVersion": "2018-08-01",
        "name": "[variables('vmInternalNics')[copyIndex('internalNics')].name]",
        "type": "Microsoft.Network/networkInterfaces",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "[variables('ilbName')]"
        ],
        "copy": {
          "name": "internalNics",
          "count": "[length(parameters('vmNamePrefix'))]"
        },
        "properties": {
          "enableAcceleratedNetworking": true,
          "enableIPForwarding": true,
          "ipConfigurations": [
            {
              "name": "[concat(variables('vmNames')[copyIndex('internalNics')].name,'Int')]",
              "properties": {
                "privateIPAllocationMethod": "Static",
                "privateIPAddress": "[variables('vmInternalNics')[copyIndex('internalNics')].privateIpAddress]",
                "subnet": {
                  "id": "[variables('internalSubnetRef')]"
                },
                "loadBalancerBackendAddressPools": [
                  {
                    "id": "[variables('ilbInternalBeRef')]"
                  }
                ]
              }
            }
          ]
        }
      },
      {
        "comments": "Firewall availability set.",
        "apiVersion": "2018-06-01",
        "type": "Microsoft.Compute/availabilitySets",
        "name": "[variables('asName')]",
        "location": "[resourceGroup().location]",
        "sku": { "name": "Aligned" },
        "properties": {
          "platformFaultDomainCount": 2,
          "platformUpdateDomainCount": 2
        }
      },
      {
        "comments": "Deploys the firewalls.",
        "apiVersion": "2018-06-01",
        "type": "Microsoft.Compute/virtualMachines",
        "name": "[variables('vmNames')[copyIndex('fws')].name]",
        "location": "[resourceGroup().location]",
        "dependsOn": [
          "mgmtNics",
          "externalNics",
          "internalNics",
          "[variables('asId')]"
        ],
        "copy": {
          "name": "fws",
          "count": "[length(parameters('vmNamePrefix'))]"
        },
        "plan": {
          "name": "[parameters('vmImageSku')]",
          "product": "[variables('vmImageOffer')]",
          "publisher": "[variables('vmImagePublisher')]"
        },
        "properties": {
          "availabilitySet": {
            "id": "[resourceId('Microsoft.Compute/availabilitySets', variables('asName'))]"
          },
          "hardwareProfile": {
            "vmSize": "[parameters('vmSize')]"
          },
          "osProfile": {
            "computerName": "[variables('vmNames')[copyIndex('fws')].name]",
            "adminUsername": "[parameters('adminUsername')]",
            "adminPassword": "[parameters('adminPassword')]"
          },
          "storageProfile": {
            "imageReference": {
              "publisher": "[variables('vmImagePublisher')]",
              "offer": "[variables('vmImageOffer')]",
              "sku": "[parameters('vmImageSku')]",
              "version": "[parameters('vmImageVersion')]"
            },
            "osDisk": {
              "name": "[concat(variables('vmNames')[copyIndex('fws')].name,'_','OsDisk')]",
              "caching": "ReadWrite",
              "createOption": "FromImage"
            }
          },
          "networkProfile": {
            "networkInterfaces": [
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vmMgmtNics')[copyIndex('fws')].name)]",
                "properties": {
                  "primary": true
                }
              },
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vmExternalNics')[copyIndex('fws')].name)]",
                "properties": {
                  "primary": false
                }
              },
              {
                "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('vmInternalNics')[copyIndex('fws')].name)]",
                "properties": {
                  "primary": false
                }
              }
            ]
          }
        }
      }
    ]
  }